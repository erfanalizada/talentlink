name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and Push Backend Services"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install OCI CLI
        run: |
          curl -L -O https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh
          chmod +x install.sh
          ./install.sh --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure OCI CLI
        run: |
          mkdir -p $HOME/.oci
          echo "${{ secrets.OCI_CLI_KEY_CONTENT }}" > $HOME/.oci/oci_api_key.pem
          chmod 600 $HOME/.oci/oci_api_key.pem

          cat > $HOME/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_CLI_USER }}
          fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_CLI_TENANCY }}
          region=${{ secrets.OCI_CLI_REGION }}
          key_file=$HOME/.oci/oci_api_key.pem
          EOF
          chmod 600 $HOME/.oci/config

      - name: Configure kubeconfig from OKE
        run: |
          mkdir -p $HOME/.kube
          $HOME/bin/oci ce cluster create-kubeconfig \
            --cluster-id ${{ secrets.OKE_CLUSTER_ID }} \
            --file $HOME/.kube/config \
            --region ${{ secrets.OCI_CLI_REGION }} \
            --token-version 2.0.0 \
            --kube-endpoint PUBLIC_ENDPOINT
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy User Service
        run: |
          kubectl apply -f k8s/backend/user/
          kubectl rollout status deployment/user-service -n default --timeout=5m

      - name: Deploy Job Service
        run: |
          kubectl apply -f k8s/backend/job/
          kubectl rollout status deployment/job-service -n default --timeout=5m

      - name: Deploy Application Service
        run: |
          kubectl apply -f k8s/backend/application/
          kubectl rollout status deployment/application-service -n default --timeout=5m

      - name: Deploy CV Service
        run: |
          kubectl apply -f k8s/backend/cv/
          kubectl rollout status deployment/cv-service -n default --timeout=5m

      - name: Deploy Matching Service
        run: |
          kubectl apply -f k8s/backend/matching/
          kubectl rollout status deployment/matching-service -n default --timeout=5m

      - name: Update Ingress
        run: |
          kubectl apply -f k8s/ingress-updated.yaml

      - name: Verify Deployment
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n default
          echo ""
          echo "=== Services ==="
          kubectl get svc -n default
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n default

      - name: Run Health Checks
        run: |
          echo "Waiting 30 seconds for services to stabilize..."
          sleep 30

          echo "Testing health endpoints..."
          curl -f https://talentlink-erfan.nl/api/users/health || echo "User service health check failed"
          curl -f https://talentlink-erfan.nl/api/jobs/health || echo "Job service health check failed"
          curl -f https://talentlink-erfan.nl/api/applications/health || echo "Application service health check failed"
          curl -f https://talentlink-erfan.nl/api/cv/health || echo "CV service health check failed"
          curl -f https://talentlink-erfan.nl/api/matching/health || echo "Matching service health check failed"
