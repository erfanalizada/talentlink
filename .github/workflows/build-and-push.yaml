name: Build and Push Images (GitOps)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # =========================================
  # DETECT CHANGES
  # =========================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      user: ${{ steps.filter.outputs.user }}
      job: ${{ steps.filter.outputs.job }}
      notif: ${{ steps.filter.outputs.notif }}
      application: ${{ steps.filter.outputs.application }}
      cv: ${{ steps.filter.outputs.cv }}
      matching: ${{ steps.filter.outputs.matching }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed services
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            auth:
              - "backend/auth-service/**"
              - "backend/shared/**"
            user:
              - "backend/user-service/**"
              - "backend/shared/**"
            job:
              - "backend/job-service/**"
              - "backend/shared/**"
            notif:
              - "backend/notification-service/**"
              - "backend/shared/**"
            application:
              - "backend/application-service/**"
              - "backend/shared/**"
            cv:
              - "backend/cv-service/**"
              - "backend/shared/**"
            matching:
              - "backend/matching-service/**"
              - "backend/shared/**"
            frontend:
              - "frontend/**"

  # =========================================
  # BACKEND SERVICE BUILDS
  # =========================================
  build-auth:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push auth-service
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-context shared=./backend/shared \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/auth-service:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/auth-service:latest \
            ./backend/auth-service \
            --push

  build-user:
    needs: detect-changes
    if: needs.detect-changes.outputs.user == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push user-service
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-context shared=./backend/shared \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/user-service:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/user-service:latest \
            ./backend/user-service \
            --push

  build-job:
    needs: detect-changes
    if: needs.detect-changes.outputs.job == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push job-service
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-context shared=./backend/shared \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/job-service:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/job-service:latest \
            ./backend/job-service \
            --push

  build-notif:
    needs: detect-changes
    if: needs.detect-changes.outputs.notif == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push notification-service
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-context shared=./backend/shared \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/notification-service:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/notification-service:latest \
            ./backend/notification-service \
            --push

  build-application:
    needs: detect-changes
    if: needs.detect-changes.outputs.application == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push application-service
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-context shared=./backend/shared \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/application-service:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/application-service:latest \
            ./backend/application-service \
            --push

  build-cv:
    needs: detect-changes
    if: needs.detect-changes.outputs.cv == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push cv-service
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-context shared=./backend/shared \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/cv-service:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/cv-service:latest \
            ./backend/cv-service \
            --push

  build-matching:
    needs: detect-changes
    if: needs.detect-changes.outputs.matching == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push matching-service
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-context shared=./backend/shared \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/matching-service:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/matching-service:latest \
            ./backend/matching-service \
            --push

  # =========================================
  # FRONTEND
  # =========================================
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: Build & Push frontend
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/talentlink-frontend:${{ github.sha }} \
            -t ghcr.io/${{ secrets.GHCR_USERNAME }}/talentlink-frontend:latest \
            ./frontend \
            --push

  # =========================================
  # UPDATE K8S MANIFESTS
  # =========================================
  update-manifests:
    needs:
      - detect-changes
      - build-auth
      - build-user
      - build-job
      - build-notif
      - build-application
      - build-cv
      - build-matching
      - build-frontend
    if: always() && !cancelled()
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: |
          git config user.email "ci@github.com"
          git config user.name "GitHub Actions"
          git pull --rebase origin main

      - name: Update manifests
        env:
          BUILD_AUTH: ${{ needs.build-auth.result }}
          BUILD_USER: ${{ needs.build-user.result }}
          BUILD_JOB: ${{ needs.build-job.result }}
          BUILD_NOTIF: ${{ needs.build-notif.result }}
          BUILD_APPLICATION: ${{ needs.build-application.result }}
          BUILD_CV: ${{ needs.build-cv.result }}
          BUILD_MATCHING: ${{ needs.build-matching.result }}
          BUILD_FRONTEND: ${{ needs.build-frontend.result }}
        run: |
          declare -A MAP=(
            ["auth"]="auth-service"
            ["user"]="user-service"
            ["job"]="job-service"
            ["notif"]="notification-service"
            ["application"]="application-service"
            ["cv"]="cv-service"
            ["matching"]="matching-service"
            ["frontend"]="talentlink-frontend"
          )

          declare -A RESULT=(
            ["auth"]="$BUILD_AUTH"
            ["user"]="$BUILD_USER"
            ["job"]="$BUILD_JOB"
            ["notif"]="$BUILD_NOTIF"
            ["application"]="$BUILD_APPLICATION"
            ["cv"]="$BUILD_CV"
            ["matching"]="$BUILD_MATCHING"
            ["frontend"]="$BUILD_FRONTEND"
          )

          for key in "${!MAP[@]}"; do
            if [[ "${RESULT[$key]}" == "success" ]]; then
              echo "Updating ${MAP[$key]} image..."
              sed -i "s|image: ghcr.io/.*/${MAP[$key]}:.*|image: ghcr.io/${{ secrets.GHCR_USERNAME }}/${MAP[$key]}:${{ github.sha }}|" \
                k8s/backend/$key/deployment.yaml 2>/dev/null || true
              sed -i "s|image: ghcr.io/.*/${MAP[$key]}:.*|image: ghcr.io/${{ secrets.GHCR_USERNAME }}/${MAP[$key]}:${{ github.sha }}|" \
                k8s/frontend/deployment.yaml 2>/dev/null || true
            fi
          done

      - name: Commit and push changes
        run: |
          git add k8s/
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "GitOps: Update images to ${{ github.sha }} [skip ci]"
          git push origin main

  # =========================================
  # NOTIFY
  # =========================================
  notify-success:
    needs: update-manifests
    if: success()
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "ðŸš€ GitOps pipeline complete"
          echo "ArgoCD will now deploy the new images."
