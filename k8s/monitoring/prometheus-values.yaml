# Prometheus Helm Values for Lightweight Monitoring
prometheus:
  prometheusSpec:
    retention: 7d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi
          storageClassName: oci-bv

    # Service monitor selector
    serviceMonitorSelectorNilUsesHelmValues: false

    # Scrape configs for TalentLink services
    additionalScrapeConfigs:
    - job_name: 'talentlink-services'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - default
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: '.*-service'
        action: keep
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_container_port_number]
        regex: '5[0-9]{3}'
        action: keep
      - source_labels: [__address__]
        target_label: __address__
        regex: '([^:]+):.*'
        replacement: '${1}:5000'

grafana:
  enabled: true
  adminPassword: "admin"  # Change in production

  persistence:
    enabled: true
    size: 5Gi
    storageClassName: oci-bv

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus-kube-prometheus-prometheus:9090
        isDefault: true

  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

  dashboards:
    default:
      talentlink-overview:
        json: |
          {
            "dashboard": {
              "title": "TalentLink Overview",
              "panels": [
                {
                  "title": "Request Rate",
                  "targets": [{"expr": "rate(http_requests_total[5m])"}]
                },
                {
                  "title": "Error Rate",
                  "targets": [{"expr": "rate(http_requests_total{status=~\"5..\"}[5m])"}]
                },
                {
                  "title": "Request Latency P95",
                  "targets": [{"expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"}]
                }
              ]
            }
          }

# Resource limits (lightweight)
prometheus-node-exporter:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

kube-state-metrics:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
